<!-- AutoCheck BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Sat Oct 10 22:52:36 EST 2015 -->
<bpel:process name="AutoCheck"
         targetNamespace="http://soacourse.unsw.edu.au/autocheck"
         suppressJoinFailure="yes"
         xmlns:tns="http://soacourse.unsw.edu.au/autocheck"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:pdv="http://pdv.soacourse.unsw.edu.au"
         xmlns:crv="http://crv.soacourse.unsw.edu.au"
         >

    <!-- Import the client WSDL -->
	<bpel:import location="AutoCheckArtifacts.wsdl" namespace="http://soacourse.unsw.edu.au/autocheck" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
    <bpel:import location="PDVCheckService.wsdl" namespace="http://pdv.soacourse.unsw.edu.au"
            importType="http://schemas.xmlsoap.org/wsdl/" />
    <bpel:import location="CRVCheckService.wsdl" namespace="http://crv.soacourse.unsw.edu.au"
            importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:AutoCheckLinkType"
                     myRole="AutoCheckProvider"
                     />
        <bpel:partnerLink name="pdvChecker"
                     partnerLinkType="tns:PDVCheckLinkType"
                     partnerRole="pdvChecker"
                     initializePartnerRole="yes"
                     />
        <bpel:partnerLink name="crvChecker"
                     partnerLinkType="tns:CRVCheckLinkType"
                     partnerRole="crvChecker"
                     initializePartnerRole="yes"
                     />
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <bpel:variable name="request"
                  messageType="tns:AutoCheckRequestMessage"/>
        <bpel:variable name="response"
                  messageType="tns:AutoCheckResponseMessage"/>
        <bpel:variable name="pdvRequest"
                  messageType="pdv:PDVCheck"/>
        <bpel:variable name="pdvResponse"
                  messageType="pdv:PDVCheckResponse"/>
        <bpel:variable name="crvRequest"
                  messageType="crv:CRVCheck"/>
        <bpel:variable name="crvResponse"
                  messageType="crv:CRVCheckResponse"/>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in AutoCheck.wsdl 
             -->
        <bpel:receive name="receiveInput" partnerLink="client"
                 portType="tns:AutoCheckService"
                 operation="check" variable="request"
                 createInstance="yes"/>
        <bpel:flow>
            <bpel:sequence name="PDVSequence">
                <bpel:assign validate="no" name="Assign">
                    <bpel:copy>
                        <bpel:from>
                            <bpel:literal>
                                <pdv:PDVCheckRequest>
                                    <pdv:licenseNo>pdv:licenseNo</pdv:licenseNo>
                                    <pdv:fullName>pdv:fullName</pdv:fullName>
                                    <pdv:postcode>pdv:postcode</pdv:postcode>
                                </pdv:PDVCheckRequest>
                            </bpel:literal>
                        </bpel:from>
                        <bpel:to variable="pdvRequest" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="request">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:licenseNo]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="pdvRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[pdv:licenseNo]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="request">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:fullName]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="pdvRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[pdv:fullName]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="request">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:postcode]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="pdvRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[pdv:postcode]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="InvokePDV" partnerLink="pdvChecker" portType="pdv:PDVCheckService" operation="PDVCheck" inputVariable="pdvRequest" outputVariable="pdvResponse">
                </bpel:invoke>
            </bpel:sequence>
            <bpel:sequence name="CRVSequence">
                <bpel:assign validate="no" name="Assign2">
                    <bpel:copy>
                        <bpel:from>
                            <bpel:literal>
                                <crv:CRVCheckRequest>
                                    <crv:licenseNo>crv:licenseNo</crv:licenseNo>
                                </crv:CRVCheckRequest>
                            </bpel:literal>
                        </bpel:from>
                        <bpel:to variable="crvRequest" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="request">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:licenseNo]]>
                            </bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="crvRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[crv:licenseNo]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="InvokeCRV" partnerLink="crvChecker" portType="crv:CRVCheckService" operation="CRVCheck" inputVariable="crvRequest" outputVariable="crvResponse">
                </bpel:invoke>
            </bpel:sequence>
        </bpel:flow>
                <bpel:assign validate="no" name="Assign1">
                    <bpel:copy>
                        <bpel:from>
                            <bpel:literal>
                                <tns:AutoCheckResponse>
                                    <tns:result>tns:result</tns:result>
                                </tns:AutoCheckResponse>
                            </bpel:literal>
                        </bpel:from>
                        <bpel:to variable="response" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from>
                            <![CDATA[concat('PDV result: ',
                                bpel:getVariableData('pdvResponse', 'parameters'),
                                '\nCRV result: ',
                                bpel:getVariableData('crvResponse', 'parameters'))]]>
                        </bpel:from>
                        <bpel:to part="parameters" variable="response">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:result]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
        <bpel:reply name="replyOutput" 
               partnerLink="client"
               portType="tns:AutoCheckService"
               operation="check" 
               variable="response"
               />
    </bpel:sequence>
</bpel:process>

